<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Usu치rios</title>
<link rel="stylesheet" href="/css/aside.css">
<link rel="stylesheet" href="/css/admin.css">

<script>
  // Redireciona para login se n칚o estiver logado
  async function checkSession() {
    try {
      const res = await fetch('/admin/users-json');
      if (res.status === 403) window.location.href = '/login.html';
    } catch {
      window.location.href = '/login.html';
    }
  }
  checkSession();
</script>
</head>

<body class="dark">
<aside>
  <div>
    <div class="logo">LOCO</div>
    <nav>
      <ul>
    <li><a href="/home"><span class="icon">游</span>Home</a></li>
    <li><a href="/admin/users"><span class="material-symbols-outlined">group</span>Users</a></li>
    <li><a href="/register"><span class="material-symbols-outlined">group</span>Users</a></li>
      </ul>
    </nav>
  </div>
  <a href="/logout">Sair</a>
</aside>

<div class="main">
  <h1>Lista de Usu치rios</h1>
  <div id="usersContainer" style="display: flex; flex-wrap: wrap; gap: 1rem;"></div>
</div>

<script>
const body = document.body;
document.querySelector('.logo').addEventListener('click', () => {
  body.classList.toggle('light');
  body.classList.toggle('dark');
});

async function fetchUsers() {
  try {
    const res = await fetch('/admin/users-json');
    const users = await res.json();
    const container = document.getElementById('usersContainer');
    container.innerHTML = '';

    users.forEach(user => {
      const div = document.createElement('div');
      div.className = 'userCard';
      div.style.border = '1px solid #ccc';
      div.style.borderRadius = '8px';
      div.style.padding = '1rem';
      div.style.width = '300px';
      div.style.background = '#fff';
      div.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';

      // Monta os dados extras (JSON)
      let extras = '';
      if (user.dados && typeof user.dados === 'object') {
        for (const key in user.dados) {
          extras += `<p><strong>${key}:</strong> ${user.dados[key]}</p>`;
        }
      }

      div.innerHTML = `
        <p><strong>ID:</strong> ${user.id}</p>
        <p><strong>Nome:</strong> ${user.name}</p>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Criado em:</strong> ${new Date(user.created_at).toLocaleString()}</p>

        ${extras ? `<div class="extras" style="display:none; margin-top:0.5rem;">${extras}</div>` : ''}

        <div style="margin-top: 0.5rem;">
          ${extras ? `<button class="toggleBtn">Expandir</button>` : ''}
          <button class="editBtn" onclick="window.location.href='/admin/edit?id=${user.id}'">Editar</button>
          <button class="deleteBtn" onclick="deleteUser(${user.id})">Deletar</button>
        </div>
      `;

      // Evento para expandir/retrair dados extras
      const toggleBtn = div.querySelector('.toggleBtn');
      if (toggleBtn) {
        const extrasDiv = div.querySelector('.extras');
        toggleBtn.addEventListener('click', () => {
          if (extrasDiv.style.display === 'none') {
            extrasDiv.style.display = 'block';
            toggleBtn.textContent = 'Retrair';
          } else {
            extrasDiv.style.display = 'none';
            toggleBtn.textContent = 'Expandir';
          }
        });
      }

      container.appendChild(div);
    });
  } catch (err) {
    console.error('Erro ao buscar usu치rios:', err);
  }
}

async function deleteUser(id) {
  if (!confirm('Deseja realmente excluir este usu치rio?')) return;
  try {
    const res = await fetch(`/admin/users/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      alert('Usu치rio deletado!');
      fetchUsers();
    } else {
      alert('Erro ao deletar usu치rio');
    }
  } catch (err) {
    console.error(err);
  }
}

// Carrega usu치rios ao abrir a p치gina
fetchUsers();
</script>
</body>
</html>
